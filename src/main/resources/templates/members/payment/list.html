<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/desktop/layout}">
<head>
    <meta charset="UTF-8">
    <title>정산 내역 조회</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div layout:fragment="adminContent" id="layoutSidenav_content">
    <main>
        <div class="container-fluid px-5">
            <h3 class="mt-5">정산 내역 조회</h3>
            <ol class="breadcrumb mb-4">
                <a href="/members/account/adminhome" class="breadcrumb-item active">홈</a>
                <a href="#" class="breadcrumb-item active no-click">매출 정산보기</a>
            </ol>

            <div class="card custom-shadow mb-4">

                <div class="card-header">
                    <div class="d-flex align-items-center mb-4 gap-3">
                        <!-- 시작일 -->
                        <div class="d-flex align-items-center">
                            <label for="startDate" class="mb-0 me-2 fw-bold">시작일</label>
                            <input type="date" id="startDate" class="form-control mb-0" style="min-width: 150px;">
                        </div>
                        <!-- 종료일 -->
                        <div class="d-flex align-items-center">
                            <label for="endDate" class="mb-0 me-2 fw-bold">종료일</label>
                            <input type="date" id="endDate" class="form-control mb-0" style="min-width: 150px;">
                        </div>
                        <!-- 정산여부 -->
                        <div class="d-flex align-items-center">
                            <label for="paidCheck" class="mb-0 me-2 fw-bold">정산여부</label>
                            <select id="paidCheck" class="form-select" style="min-width: 150px;">
                                <option value="both">전체</option>
                                <option value="paid">정산완료</option>
                                <option value="none">미정산</option>
                            </select>
                        </div>

                        <!-- 날짜별 조회하기 버튼 -->
                        <button id="dateBtn" class="btn btn-secondary">
                            <i class="fas fa-calendar-day me-2"></i>날짜조회
                        </button>
                        <!-- 주문별 조회하기 버튼 -->
                        <button id="orderBtn" class="btn btn-primary">
                            <i class="fas fa-box-open me-2"></i>주문조회
                        </button>
                        <!-- 메뉴별 조회하기 버튼 -->
                        <button id="menuBtn" class="btn btn-secondary">
                            <i class="fas fa-utensils me-2"></i>메뉴조회
                        </button>
                        <!-- 엑셀 다운로드 버튼 -->
                        <button id="downloadBtn" class="btn btn-outline-success">
                            <i class="fas fa-download me-2"></i>엑셀
                        </button>
                    </div>
                </div>


                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card custom-shadow mb-4">
                                <div class="card-header">정산 테이블</div>
                                <div class="card-body">
                                    <table id="payInfo" class="table table-striped table-bordered mb-4">
                                        <thead class="table-light">
                                        <tr>
                                            <th onclick="sortTable(0)">결제 ID</th>
                                            <th onclick="sortTable(1)">결제 항목</th>
                                            <th onclick="sortTable(2)">정산여부</th>
                                            <th onclick="sortTable(3)">결제일</th>
                                            <th onclick="sortTable(4)">금액</th>
                                            <th onclick="sortTable(5)">부가세</th>
                                            <th onclick="sortTable(6)">합계금액</th>
                                        </tr>
                                        </thead>
                                        <tbody>

                                        </tbody>
                                    </table>
                                    <!-- 메뉴 관련 테이블을 추가하려면 동일한 테이블 내에서 메뉴 항목들을 추가합니다 -->
                                    <table id="menuInfo" class="table table-striped table-bordered mb-4" style="display:none;">
                                        <thead class="table-light">
                                        <tr>
                                            <th>메뉴 이름</th>
                                            <th>가격</th>
                                            <th>수량</th>
                                            <th>총 금액</th>
                                        </tr>
                                        </thead>
                                        <tbody id="menuInfoBody">

                                        </tbody>
                                    </table>

                                    <div class="mt-4 ps-2">
                                        <h5>총 금액: <span id="totalPriceSum" class="text-primary">0</span> 원</h5>
                                        <h5>부가세 합계: <span id="totalVat" class="text-warning">0</span> 원</h5>
                                        <h5>부가세 포함 최종 금액: <span id="totalVatSum" class="text-success">0</span> 원</h5>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card custom-shadow mb-4">
                                <div class="card-header">정산 차트</div>
                                <div class="card-body">
                                    <!-- 차트를 보여줄 캔버스 요소 -->
                                    <canvas id="dynamicChart" width="400" height="200"></canvas>

                                    <!-- 각 차트별로 보이도록 할 div 영역 (선택적으로 사용) -->
                                    <div id="paymentChart" style="display: none;">
                                        <canvas id="paymentCanvas" width="400" height="200"></canvas>
                                    </div>
                                    <div id="orderChart" style="display: none;">
                                        <canvas id="orderCanvas" width="400" height="200"></canvas>
                                    </div>
                                    <div id="menuChart" style="display: none;">
                                        <canvas id="menuCanvas" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>


    <script>
        $(document).ready(function () {

            // 데이터를 저장할 변수
            let paymentData = []
            let orderData = []
            let menuData = []
            let chartInstance = null

            // 차트 데이터를 가져오는 함수
            function getChartData(chartType) {
                console.log(`차트 데이터 가져오기: ${chartType}`);  // 디버깅용 로그

                let labels = []
                let data = []

                // chartType에 따라 데이터를 처리
                switch (chartType) {

                    case 'payment':
                        paymentData.forEach(function (payment) {
                            labels.push(payment.totalId)
                            data.push(payment.totalPrice)
                        })
                        break

                    case 'order':
                        orderData.forEach(function (order) {
                            labels.push(order.id)
                            data.push(order.totalPrice)
                        })
                        break

                    case 'menu':
                        menuData.forEach(function (item) {
                            labels.push(item.menuName)
                            data.push(item.price)
                        })
                        break

                    default:
                        break
                }

                console.log('차트 데이터:', { labels: labels, data: data }); // 디버깅용 로그
                return { labels: labels, data: data }
            }

            // 차트 업데이트 함수
            function updateChart(chartType) {
                console.log(`차트 업데이트: ${chartType}`);  // 디버깅용 로그

                let chartData = getChartData(chartType)

                // 차트 인스턴스가 있을 때 업데이트
                if (chartInstance) {
                    chartInstance.data.labels = chartData.labels
                    chartInstance.data.datasets[0].data = chartData.data
                    chartInstance.update()
                    console.log('차트 업데이트 완료');  // 디버깅용 로그
                }
            }

            // 차트 생성 함수
            function createChart(chartType) {
                console.log(`차트 생성: ${chartType}`);  // 디버깅용 로그
                let chartData = getChartData(chartType)

                let ctx = document.getElementById('dynamicChart').getContext('2d')

                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: chartType === 'payment' ? '결제 금액' : chartType === 'order' ? '주문 금액' : '메뉴 금액',
                            data: chartData.data,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                })
            }

            // 기본적으로 'payment' 차트 생성
            createChart('payment')

            setPeriodAndLoad()

            function handleDateAndLoadData(chartType) {
                let startDateStr = $('#startDate').val()
                let endDateStr = $('#endDate').val()

                if (!startDateStr || !endDateStr) {
                    alert('시작일과 종료일을 모두 선택해 주세요.')
                    return
                }

                let startDate = new Date(startDateStr)
                let endDate = new Date(endDateStr)

                if (startDate > endDate) {
                    alert('시작일은 종료일보다 늦을 수 없습니다.')
                    return
                }

                startDateStr = formatDate(startDate)
                endDateStr = formatDate(endDate)

                console.log(`차트 타입: ${chartType}, 시작일: ${startDateStr}, 종료일: ${endDateStr}`); // 디버깅용 로그

                switch (chartType) {
                    case 'payment':
                        loadPaymentData(startDateStr, endDateStr)
                        break
                    case 'order':
                        loadOrderData(startDateStr, endDateStr)
                        break
                    case 'menu':
                        loadMenuData(startDateStr, endDateStr)
                        break
                    default:
                        alert('알 수 없는 차트 타입입니다.')
                        return
                }

                showChart(chartType)
            }

            $('#dateBtn').on('click', function () {
                handleDateAndLoadData('payment')
            })

            $('#orderBtn').on('click', function () {
                handleDateAndLoadData('order')
            })

            $('#menuBtn').on('click', function () {
                handleDateAndLoadData('menu')
            })

            function showChart(chartId) {
                console.log(`차트 표시: ${chartId}`);  // 디버깅용 로그
                $('#paymentChart').hide()
                $('#orderChart').hide()
                $('#menuChart').hide()
                $('#' + chartId).show()
            }

            function downloadExcel(data) {
                console.log('엑셀 다운로드 시작');  // 디버깅용 로그
                let wb = XLSX.utils.book_new()
                let ws = XLSX.utils.json_to_sheet(data)

                XLSX.utils.book_append_sheet(wb, ws, '정산내역')
                XLSX.writeFile(wb, '정산_내역.xlsx')
                console.log('엑셀 다운로드 완료');  // 디버깅용 로그
            }

            $('#downloadBtn').on('click', function () {
                downloadExcel(paymentData)
            })

            function formatDate(date) {
                let year = date.getFullYear()
                let month = String(date.getMonth() + 1).padStart(2, '0')
                let day = String(date.getDate()).padStart(2, '0')
                return `${year}-${month}-${day}`
            }

            function setPeriodAndLoad() {
                let today = new Date()
                let startDate = new Date(today.getFullYear(), today.getMonth(), 2)
                let endDate = new Date(today.getFullYear(), today.getMonth() + 1, 1)
                let format = (d) => d.toISOString().split('T')[0]

                $('#startDate').val(format(startDate))
                $('#endDate').val(format(endDate))

                loadPaymentData(format(startDate), format(endDate))
            }

            function loadPaymentData(startDateStr, endDateStr) {
                console.log('결제 데이터 로드 시작');  // 디버깅용 로그
                let storeId = $('#storeId').val()
                if (storeId === "") storeId = null

                let data = {
                    startDate: startDateStr,
                    endDate: endDateStr,
                    storeId: storeId,
                    paidCheck: $('#paidCheck').val(),
                    download: false
                }

                $.ajax({
                    url: '/api/payment/totalPrice',
                    method: 'get',
                    data: data,
                    success: function (response) {
                        if(response===undefined){
                            alert("해당 날짜 및 조건에 존재하는 주문건이 없습니다.")
                            return;
                        }
                        console.log('결제 데이터 로드 성공', response);  // 디버깅용 로그
                        paymentData = response
                        orderData = response
                        menuData = response

                        handleFetchedData(response)
                        updatePaymentTables(response)
                        updateChart('payment')
                    },
                    error: function (xhr, status, error) {
                        console.error("조회 실패:", status, error, xhr.responseText)
                    }
                })
            }

            function loadOrderData(startDateStr, endDateStr) {
                loadPaymentData(startDateStr, endDateStr)
            }

            function loadMenuData(startDateStr, endDateStr) {
                loadPaymentData(startDateStr, endDateStr)
            }

            function handleFetchedData(response) {
                console.log("메뉴 데이터 로드 시작");
                let menuList = [];

                response.forEach(payment => {
                    if (payment.ordersDTOList && Array.isArray(payment.ordersDTOList)) {
                        payment.ordersDTOList.forEach(order => {
                            if (order.ordersItemDTOList && Array.isArray(order.ordersItemDTOList)) {
                                order.ordersItemDTOList.forEach(item => {
                                    menuList.push({
                                        menuName: item.menuDTO ? item.menuDTO.name : '-',
                                        menuPrice: item.menuDTO ? item.menuDTO.price : 0,
                                        quantity: item.quantity || 0,
                                        totalPrice: (item.menuDTO ? item.menuDTO.price : 0) * (item.quantity || 0)
                                    });
                                });
                            }
                        });
                    }
                });

                console.log("menuList:", menuList);

                // 메뉴 테이블 표시
                $('#menuInfo').show(); // 메뉴 테이블 보이기
                let tbody = $('#menuInfoBody');
                tbody.empty(); // 테이블 비우기

                // 메뉴 데이터를 테이블에 추가
                menuList.forEach(menuItem => {
                    let row = $('<tr>');
                    row.html(`
                                <td>${menuItem.menuName}</td>
                                <td>${menuItem.menuPrice.toLocaleString()} 원</td>
                                <td>${menuItem.quantity}</td>
                                <td>${menuItem.totalPrice.toLocaleString()} 원</td>
                            `);
                    tbody.append(row);
                });
            }


            function updatePaymentTables(response) {
                console.log('결제 테이블 업데이트 시작');  // 디버깅용 로그
                let payInfo = $('#payInfo tbody')
                payInfo.empty()

                let totalPriceSum = 0
                let totalVatSum = 0
                let totalVat = 0

                response.forEach(function (payment) {
                    let formattedDate = new Date(payment.regTime)
                    let formattedDateString = formattedDate.getFullYear() + '.' +
                        String(formattedDate.getMonth() + 1).padStart(2, '0') + '.' +
                        String(formattedDate.getDate()).padStart(2, '0')

                    let formattedUnpaid = payment.unpaid ? payment.unpaid.toLocaleString() : '0'
                    let formattedVat = payment.vat ? payment.vat.toLocaleString() : '0'
                    let formattedTotalPrice = payment.totalPrice ? payment.totalPrice.toLocaleString() : '0'

                    let checkPaidText = (payment.checkPaid === 'paid') ? '정산완료' : '미정산'

                    let itemNames = ''
                    if (payment.ordersDTOList && payment.ordersDTOList.length > 0) {
                        let firstOrder = payment.ordersDTOList[0]
                        if (firstOrder.ordersItemDTOList && firstOrder.ordersItemDTOList.length > 0) {
                            itemNames = firstOrder.ordersItemDTOList.map(item => item.menuDTO.name).join(', ') || '-'
                        }
                    }

                    let storeName = payment.ordersDTOList && payment.ordersDTOList[0] ? payment.ordersDTOList[0].storeDTO.name : '-'

                    if (itemNames === '') {
                        itemNames = storeName
                    }

                    payInfo.append(`
                    <tr>
                        <td>${payment.totalId}</td>
                        <td>${itemNames || storeName}</td>
                        <td>${checkPaidText}</td>
                        <td>${formattedDateString}</td>
                        <td>${formattedUnpaid}</td>
                        <td>${formattedVat}</td>
                        <td>${formattedTotalPrice}</td>
                    </tr>
                `)

                    totalPriceSum += payment.totalPrice
                    totalVat += payment.vat
                    totalVatSum += (payment.totalPrice + payment.vat)
                })

                $('#totalPriceSum').text(totalPriceSum.toLocaleString())
                $('#totalVat').text(totalVat.toLocaleString())
                $('#totalVatSum').text(totalVatSum.toLocaleString())
                console.log('결제 테이블 업데이트 완료');  // 디버깅용 로그
            }
        })
    </script>



</div>
</body>
</html>
