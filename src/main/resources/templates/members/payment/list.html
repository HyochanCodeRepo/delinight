<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/desktop/layout}">
<head>
    <meta charset="UTF-8">
    <title>정산 내역 조회</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div layout:fragment="adminContent" id="layoutSidenav_content">
    <main>
        <div class="container-fluid px-5">
            <h3 class="mt-5">정산 내역 조회</h3>
            <ol class="breadcrumb mb-4">
                <a href="/members/account/adminhome" class="breadcrumb-item active">홈</a>
                <a href="#" class="breadcrumb-item active no-click">매출 정산보기</a>
            </ol>

            <div class="card custom-shadow mb-4">

                <div class="card-header">
                    <div class="d-flex align-items-center mb-4 gap-3">
                        <!-- 시작일 -->
                        <div class="d-flex align-items-center">
                            <label for="startDate" class="mb-0 me-2 fw-bold">시작일</label>
                            <input type="date" id="startDate" class="form-control mb-0" style="min-width: 150px;">
                        </div>
                        <!-- 종료일 -->
                        <div class="d-flex align-items-center">
                            <label for="endDate" class="mb-0 me-2 fw-bold">종료일</label>
                            <input type="date" id="endDate" class="form-control mb-0" style="min-width: 150px;">
                        </div>
                        <!-- 정산여부 -->
                        <div class="d-flex align-items-center">
                            <label for="paidCheck" class="mb-0 me-2 fw-bold">정산여부</label>
                            <select id="paidCheck" class="form-select" style="min-width: 150px;">
                                <option value="both">전체</option>
                                <option value="paid">정산완료</option>
                                <option value="none">미정산</option>
                            </select>
                        </div>

                        <!-- 날짜별 조회하기 버튼 -->
                        <button id="dateSearchBtn" class="btn btn-secondary">
                            <i class="fas fa-calendar-day me-2"></i>날짜조회
                        </button>
                        <!-- 주문별 조회하기 버튼 -->
                        <button id="loadPaymentBtn" class="btn btn-primary">
                            <i class="fas fa-box-open me-2"></i>주문조회
                        </button>
                        <!-- 메뉴별 조회하기 버튼 -->
                        <button id="menuSearchBtn" class="btn btn-secondary">
                            <i class="fas fa-utensils me-2"></i>메뉴조회
                        </button>
                        <!-- 엑셀 다운로드 버튼 -->
                        <button id="downloadBtn" class="btn btn-outline-success">
                            <i class="fas fa-download me-2"></i>엑셀
                        </button>
                    </div>
                </div>


                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card custom-shadow mb-4">
                                <div class="card-header">정산 테이블</div>
                                <div class="card-body">
                                    <table id="payInfo" class="table table-striped table-bordered mb-4">
                                        <thead class="table-light">
                                        <tr>
                                            <th>결제 ID</th>
                                            <th>결제 항목</th>
                                            <th>정산여부</th>
                                            <th>결제일</th>
                                            <th>금액</th>
                                            <th>부가세</th>
                                            <th>합계금액</th>
                                        </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                    <div class="mt-4 ps-2">
                                        <h5>총 금액: <span id="totalPriceSum" class="text-primary">0</span> 원</h5>
                                        <h5>부가세 합계: <span id="totalVat" class="text-warning">0</span> 원</h5>
                                        <h5>부가세 포함 최종 금액: <span id="totalVatSum" class="text-success">0</span> 원</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card custom-shadow mb-4">
                                <div class="card-header">정산 차트</div>
                                <div class="card-body">
                                    <div class="col-md-6 d-flex align-items-center justify-content-center">
                                        <canvas id="paymentChart" width="400" height="500"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        $(document).ready(function () {

            let paymentData = [];  // 결제 데이터를 저장할 변수

            setPeriodAndLoad(); // 초기값 설정 및 데이터 로드

            // 날짜별 조회 버튼 클릭 시
            $('#dateSearchBtn').on('click', function () {
                let startDateStr = $('#startDate').val();
                let endDateStr = $('#endDate').val();

                console.log('날짜조회 버튼 클릭됨');
                console.log('시작일:', startDateStr, '종료일:', endDateStr);

                if (!startDateStr || !endDateStr) {
                    alert('시작일과 종료일을 모두 선택해 주세요.');
                    return;
                }

                let startDate = new Date(startDateStr);
                let endDate = new Date(endDateStr);

                if (startDate > endDate) {
                    alert('시작일은 종료일보다 늦을 수 없습니다.');
                    return;
                }

                // 날짜를 YYYY-MM-DD 형식으로 변환
                startDateStr = formatDate(startDate);
                endDateStr = formatDate(endDate);

                loadPaymentData(startDateStr, endDateStr);
            });

            // 기간 설정 및 데이터 로드
            function setPeriodAndLoad() {
                console.log('기간 설정 및 데이터 로드 시작');
                let today = new Date();
                let startDate = new Date(today.getFullYear(), today.getMonth(), 2);    // 시작일: 해당 월 1일
                let endDate = new Date(today.getFullYear(), today.getMonth() + 1, 1);   // 종료일: 해당 월 마지막 날
                let format = (d) => d.toISOString().split('T')[0];

                // 기본값 설정 (해당 월의 1일과 마지막 날)
                $('#startDate').val(format(startDate));
                $('#endDate').val(format(endDate));

                // 자동 조회
                loadPaymentData(format(startDate), format(endDate));
            }

            // 결제 데이터 로드
            function loadPaymentData(startDateStr, endDateStr) {
                console.log('결제 데이터 로드 시작');
                console.log('시작일:', startDateStr, '종료일:', endDateStr);

                let storeId = $('#storeId').val();
                if (storeId === "") storeId = null;

                let data = {
                    startDate: startDateStr,
                    endDate: endDateStr,
                    storeId: storeId,
                    paidCheck: $('#paidCheck').val(),
                    download: false
                };

                console.log('요청 데이터:', data);

                $.ajax({
                    url: `/api/payment/totalPrice`,
                    method: 'get',
                    data: data,
                    success: function (response) {
                        console.log('결제 데이터 조회 성공:', response);
                        paymentData = response;          // 데이터 저장
                        updatePaymentTables(response);   // 테이블 업데이트
                        updatePaymentChart(response);    // 차트 업데이트
                    },
                    error: function (xhr, status, error) {
                        console.error("조회 실패:", status, error, xhr.responseText);
                    }
                });
            }

            // 날짜 포맷팅 함수 (YYYY-MM-DD)
            function formatDate(date) {
                let year = date.getFullYear();
                let month = String(date.getMonth() + 1).padStart(2, '0');
                let day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // 결제 테이블 업데이트
            function updatePaymentTables(response) {
                let payInfo = $('#payInfo tbody');
                payInfo.empty();

                let totalPriceSum = 0;
                let totalVatSum = 0;
                let totalVat = 0;

                if(response!==undefined) {

                response.forEach(function (payment) {
                    let formattedDate = new Date(payment.regTime);
                    let formattedDateString = formattedDate.getFullYear() + '.' +
                        String(formattedDate.getMonth() + 1).padStart(2, '0') + '.' +
                        String(formattedDate.getDate()).padStart(2, '0');

                    let formattedUnpaid = payment.unpaid.toLocaleString();
                    let formattedVat = payment.vat.toLocaleString();
                    let formattedTotalPrice = payment.totalPrice.toLocaleString();

                    let checkPaidText = (payment.checkPaid === 'paid') ? '정산완료' : '미정산';

                    // 주문 이름과 스토어 이름을 가져오기
                    let itemNames = '';  // 여러 메뉴를 표시할 변수
                    if (payment.ordersDTOList && payment.ordersDTOList.length > 0) {
                        let firstOrder = payment.ordersDTOList[0]; // 첫 번째 주문을 확인
                        if (firstOrder.ordersItemDTOList && firstOrder.ordersItemDTOList.length > 0) {
                            // 여러 개의 주문 항목 이름을 한 번에 가져오기
                            itemNames = firstOrder.ordersItemDTOList.map(item => item.menuDTO.name).join(', ') || '-';  // menuDTO의 name을 가져와서 표시
                        }
                    }

                    // 첫 번째 주문의 스토어 이름
                    let storeName = payment.ordersDTOList && payment.ordersDTOList[0] ? payment.ordersDTOList[0].storeDTO.name : '-';

                    payInfo.append(`
                                    <tr>
                                        <td>${payment.totalId}</td>
                                        <td>${itemNames || storeName}</td>
                                        <td>${checkPaidText}</td>
                                        <td>${formattedDateString}</td>
                                        <td>${formattedUnpaid}</td>
                                        <td>${formattedVat}</td>
                                        <td>${formattedTotalPrice}</td>
                                    </tr>
                                    `);

                    totalPriceSum += payment.totalPrice;
                    totalVat += payment.vat;
                    totalVatSum += (payment.totalPrice + payment.vat);
                });

                    $('#totalPriceSum').text(totalPriceSum.toLocaleString());
                    $('#totalVat').text(totalVat.toLocaleString());
                    $('#totalVatSum').text(totalVatSum.toLocaleString());

                } else {
                    $('#totalPriceSum').text("조회된 데이터가 없습니다.");
                    $('#totalVat').text("조회된 데이터가 없습니다.");
                    $('#totalVatSum').text("조회된 데이터가 없습니다.");
                }

            }

            // 결제 차트 업데이트
            function updatePaymentChart(response) {
                let labels = [];
                let priceData = [];
                let vatData = [];

                response.forEach(function (payment) {
                    labels.push(payment.totalId);
                    priceData.push(payment.totalPrice);
                    vatData.push(payment.vat);
                });

                new Chart(document.getElementById('paymentChart'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '금액',
                            data: priceData,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                            {
                                label: '부가세',
                                data: vatData,
                                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                                borderColor: 'rgba(255, 159, 64, 1)',
                                borderWidth: 1
                            }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

        });
    </script>



</div>
</body>
</html>
