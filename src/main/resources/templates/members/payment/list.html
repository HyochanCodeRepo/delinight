<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/desktop/layout}"
>
<head>
    <meta charset="UTF-8">
    <title>정산 내역 조회</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>

<div layout:fragment="adminContent" id="layoutSidenav_content">
    <main>
        <div class="container-fluid px-5">

            <h3 class="mt-5">정산 내역 조회</h3>
            <ol class="breadcrumb mb-4">
                <a href="/members/account/adminhome" class="breadcrumb-item active">홈</a>
                <a href="#" class="breadcrumb-item active no-click">매출 정산보기</a>
            </ol>

            <div class="card custom-shadow mb-4">
                <div class="card-body ">

                    <form id="paymentForm">

                        <div class="row mb-1">

                            <label class="col-sm-2 col-form-label form-label" for="startDate">시작</label>
                            <div class="col-sm-4">
                                <input type="date" id="startDate" name="startDate">
                            </div>
                            <label class="col-sm-2 col-form-label form-label" for="endDate">종료</label>
                            <div class="col-sm-4">
                                <input type="date" id="endDate" name="endDate">
                            </div>

                        </div>

                        <div class="row mb-1">

                            <div class="col-3">
                                <label class="col-sm-2 col-form-label form-label" for="type">타입</label>
                                <select id="type" name="type">
                                    <option value="CENTER">본사</option>
                                    <option value="BRANCH">지점</option>
                                    <option value="HOTEL">호텔</option>
                                    <option value="STORE" selected>가맹점</option>
                                </select>
                            </div>

                            <div class="col-3">
                                <label class="col-sm-2 col-form-label form-label" for="orderType">결제</label>
                                <select id="orderType" name="orderType">
                                    <option value="">전체</option>
                                    <option value="선결제">선결제</option>
                                    <option value="후결제">후결제</option>
                                </select>
                            </div>

                            <div class="col-3">
                                <label class="col-sm-2 col-form-label form-label" for="paidCheck">정산</label>
                                <select id="paidCheck" name="paidCheck">
                                    <option value="">전체</option>
                                    <option value="paid">정산완료</option>
                                    <option value="none">미정산</option>
                                </select>
                            </div>

                            <div class="d-flex col-3">
                                <button class="btn btn-primary" type="submit">조회</button>
                                <button class="btn btn-outline-primary" id="downloadExcel">엑셀</button>
                            </div>

                        </div>

                        <div class="row">
                            <!-- 테이블 영역 -->
                            <div class="col-md-6">
                                <div>
                                    <table id="paymentResults" class="table">
                                        <thead>
                                        <tr>
                                            <th>결제 ID</th>
                                            <th>결제일시</th>
                                            <th>정산여부</th>
                                            <th>금액</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <!-- 테이블 내용 -->
                                        </tbody>
                                    </table>
                                </div>
                                <div>
                                    <div id="unpaidPrice">미결제 금액: 0원</div>
                                    <div id="totalPrice">총 결제 금액: 0원</div>
                                </div>
                            </div>

                            <!-- 차트 영역 -->
                            <div class="col-md-6">
                                <canvas id="paymentChart"></canvas>
                            </div>
                        </div>

                    </form>

                </div>
            </div>






        </div>
    </main>
    <script>
        console.log("여기 진입은함?")

        // 이번 달 자동 조회 함수
        function loadCurrentMonth() {
            let now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth(); // 0-based (1월 = 0)

            // 시작일: 1일
            let startDate = new Date(year, month, 2)

            // 종료일: 다음 달 0일 == 이번 달 마지막 날
            let endDate = new Date(year, month + 1, 1)

            let formattedStartDate = startDate.toISOString().slice(0, 10)
            let formattedEndDate = endDate.toISOString().slice(0, 10)

            // 날짜 input에 기본값 세팅
            $('#startDate').val(formattedStartDate);
            $('#endDate').val(formattedStartDate);

            // 자동 조회용 데이터 구성
            const queryData = {
                type: $('#type').val(), // 기본은 "STORE"
                startDate: formattedStartDate,
                endDate: formattedEndDate,
                orderType: '',       // 전체
                paidCheck: ''        // 전체
            };

            console.log("자동 조회 데이터:", queryData);
            loadPayment(queryData);
        }

        // 페이지 로드 시 이번 달 자동 조회
        $(document).ready(function () {
            loadCurrentMonth();
        });

        // 공통 함수 : 결제 정산 목록 조회
        function loadPayment(data) {
            $.ajax({
                url: '/api/payment/totalPrice',
                type: 'GET',
                data: data,
                success: function (response) {
                    console.log("정산 데이터 조회 완료", response);

                    $('#paymentResults tbody').empty();

                    let totalPrice = 0      // 총 결제 금액
                    let unpaidPrice = 0     // 미정산 금액
                    let totalVat = 0        // 부가세 합계
                    let charData = {
                        label: [],  // x축
                        datasets: [{
                            label: '금액',
                            data: [],   // y축
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]

                    }

                    if (response.length === 0) {
                        $('#paymentResults tbody').append('<tr><td colspan="10">정산 데이터가 없습니다.</td></tr>')
                        $('#totalPrice').text('총 결제 금액: 0원')
                        $('#unpaidPrice').text('미결제 금액: 0원')
                        return;
                    }

                    response.forEach(function (payment) {

                        payment.ordersDTOList.forEach(function (order) {

                            let thisPrice = Number(order.totalPrice) || 0
                            totalPrice += totalPrice

                            let isUnpaid = order.isPaid !== 'paid'
                            let thisUnpaid = isUnpaid ? thisPrice : 0
                            unpaidPrice += thisUnpaid

                            let vat = thisUnpaid * 0.1
                            totalVat += vat

                            let regTimeFormat = new Date(payment.regTime).toLocaleDateString('ko-KR', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            }).replaceAll('.','-')

                            let str = `<tr>
                                         <td>${payment.totalId}</td>
                                         <td>${regTimeFormat}</td>
                                         <td>${payment.checkPaid}</td>
                                         <td>${thisPrice.toLocaleString()}원</td>
                                       </tr>`;

                            $('#paymentResults tbody').append(str);

                            // 차트 데이터 추가
                            charData.label.push(payment.regTime)
                            charData.datasets[0].data.push(thisPrice)

                        });
                    });

                    let totalPriceWithUnpaid = totalPrice + unpaidPrice + totalVat
                    let unpaidPriceWithVat = unpaidPrice + totalVat

                    $('#totalPrice').text(`총 결제 금액 : ${totalPriceWithUnpaid.toLocaleString()}원`)
                    $('#unpaidPrice').text(`미결제 금액 : ${unpaidPriceWithVat.toLocaleString()}원 (부가세) : ${totalVat.toLocaleString()}원 포함`)

                    // 차트 그리기
                    drawChart(charData)

                },
                error: function (xhr, status, error) {
                    console.log("에러 발생:", xhr, status, error);
                    if (xhr.status === 400) {
                        console.log("잘못된 요청(400 Error)입니다.");
                    } else if (xhr.status === 404) {
                        console.log("정산 데이터(404 Error)가 없습니다.");
                    } else if (xhr.status === 500) {
                        console.log("서버 오류가 발생(500 Error)했습니다.");
                    } else {
                        console.log("기타 오류 발생", xhr.responseText);
                    }
                }
            })
        }

        // 차트 그리기 함수
        function drawChart(data) {

            let ctx = document.getElementById('paymentChart').getContext('2d')
            let myChart = new Chart(ctx, {

                type: 'bar',
                data: data,
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback:function (value) {
                                    return value.toLocaleString() + '원'
                                }
                            }
                        }
                    }
                }

            })
        }

        // 조회 버튼 클릭 시 필터 기반 조회
        $('#paymentForm').on('submit', function (e) {
            e.preventDefault();
            let queryData = {
                type: $('#type').val(),
                startDate: $('#startDate').val(),
                endDate: $('#endDate').val(),
                orderType: $('#orderType').val(),
                paidCheck: $('#paidCheck').val()
            }
            console.log("전송 데이터:", queryData)
            loadPayment(queryData)
        })

        // 엑셀 다운로드 버튼 클릭 시 엑셀 파일 생성
        $('#downloadExcel').click(function () {
            let table = document.getElementById('paymentResults');
            let download = XLSX.utils.table_to_book(table, {sheet: "결제내역"});

            // 엑셀 파일로 다운로드
            XLSX.writeFile(download, "payment_details.xlsx");
        });

    </script>
</div>



</body>
</html>
