<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/desktop/layout}">
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <title>고객만족도 평가</title>
</head>
<body>

<div layout:fragment="adminContent" id="layoutSidenav_content">

    <main>

        <div class="container-fluid px-5">
            <h3 class="mt-5">고객만족도 평가</h3>
            <ol class="breadcrumb mb-4">
                <a href="/members/account/home" class="breadcrumb-item active">홈</a>
                <a href="/members/nps/list" class="breadcrumb-item active">데이터테이블</a>
                <a href="/members/nps/chart" class="breadcrumb-item active">통계</a>
            </ol>
        </div>

        <div class="card custom-shadow mb-4">
            <div class="card-body">

                <div id="centerManagerView" style="display: none;"></div>
                <div id="hotelManagerView" style="display: none;"></div>
                <div id="storeManagerView" style="display: none;"></div>

                <div class="d-flex justify-content-start gap-2" style="gap: 10px;">

                    <div>

                        <label for="startDate">시작일</label>
                        <input type="date" id="startDate" name="startDate">

                        <label for="endDate">종료일</label>
                        <input type="date" id="endDate" name="endDate">

                        <button id="selectBtn">조회</button>

                        <label for="type">차트 유형</label>
                        <select id="type" name="type">
                            <option value="chartAll">전체</option>
                            <option value="hotelChart">호텔</option>
                            <option value="storeChart">스토어</option>
                        </select>

                    </div>

                    <div class="tabs">
                        <button id="chartAll">전체</button>
                        <button id="hotelChart">호텔</button>
                        <button id="storeChart">스토어</button>
                    </div>

                </div>

                <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap; margin-top: 20px;">

                    <canvas id="pieChart" width="200" height="100"></canvas>
                    <canvas id="barChart" width="200" height="100"></canvas>

                </div>

            </div>
        </div>

    </main>

    <script th:inline="javascript">

        $(document).ready(function () {

            // 사용자 역할별 화면 표시
            const role = [[${role}]]
            console.log(`[초기화] 사용자 권한: ${role}`)
            initRoleView(role)

            function initRoleView(role) {
                switch (role) {
                    case 'SUPERADMIN':
                        $('#centerManagerView').show()
                        $('#chartAll').show()
                        $('#hotelChart').show()
                        $('#storeChart').show()
                        break
                    case 'ADMIN':
                        $('#hotelManagerView').show()
                        $('#chartAll').show()
                        $('#hotelChart').show()
                        $('#storeChart').show()
                        break
                    case 'STOREADMIN':
                        $('#storeManagerView').show()
                        $('#chartAll').show()
                        $('#hotelChart').hide()
                        $('#storeChart').show()
                        break
                    default:
                        console.warn('알 수 없는 역할:', role)
                }
            }

            // 전역 변수 선언 및 초기 날짜 설정
            let pieChartInstance = null
            let barChartInstance = null

            let today = new Date()
            let startOfMonth = new Date(today.getFullYear(), today.getMonth(), 2)
            let endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1)
            let switchType;

            $('#startDate').val(startOfMonth.toISOString().split('T')[0])
            $('#endDate').val(endOfMonth.toISOString().split('T')[0])
            console.log('[초기화] 시작일:', $('#startDate').val())
            console.log('[초기화] 종료일:', $('#endDate').val())

            $('#type').val('chartAll') // 기본 차트 유형

            // 탭 클릭 이벤트 처리
            $('#chartAll').on('click', () => {
                console.log('전체 차트 버튼 클릭')
                switchTab('all')
            })

            $('#hotelChart').on('click', () => {
                console.log('호텔 차트 버튼 클릭')
                switchTab('hotelChart')
            })

            $('#storeChart').on('click', () => {
                console.log('스토어 차트 버튼 클릭')
                switchTab('storeChart')
            })

            // 차트 유형 변경 시 데이터 재요청
            $('#type').on('click', function () {
                const startDate = $('#startDate').val()
                const endDate = $('#endDate').val()
                const type = $(this).val()
                chartDate(startDate, endDate, type)
                console.log("기본 차트 유형 변경 이벤트 :", startDate, endDate, type)
            })

            // 날짜 조회 버튼 클릭 이벤트 처리
            $('#selectBtn').on('click',function () {
                let startDate = $('#startDate').val()
                let endDate = $('#endDate').val()
                let type = $('#type').val()
                chartDate(startDate, endDate, type)
                console.log("조회 버튼 클릭 변경 이벤트 : ", startDate, endDate, type)
            })

            // 탭 버튼 클릭 시 chartDate 실행 + select 값 연동
            function switchTab(type) {
                const startDate = $('#startDate').val()
                const endDate = $('#endDate').val()
                switchType = type
                chartDate(startDate, endDate, switchType)
                console.log("탭 버튼 클릭 시 실행 : ", startDate, endDate, switchType)
            }

            // 페이지 로드 시 기본 차트 호출
            const startType = $('#type').val()
            chartDate($('#startDate').val(), $('#endDate').val(), startType)
            console.log("페이지 로드 시 차트 요청:", $('#startDate').val(), $('#endDate').val(), startType)

            // 평균 점수 계산 함수
            function questionScore(data) {
                let scoreSum = {'1번 문항': 0, '2번 문항': 0, '3번 문항': 0, '4번 문항': 0, '5번 문항': 0}
                let count = data.length

                data.forEach(score => {
                    scoreSum['1번 문항'] += score.questionOne
                    scoreSum['2번 문항'] += score.questionTwo
                    scoreSum['3번 문항'] += score.questionThree
                    scoreSum['4번 문항'] += score.questionFour
                    scoreSum['5번 문항'] += score.questionFive
                })

                Object.keys(scoreSum).forEach(key => {
                    scoreSum[key] = (scoreSum[key] / count).toFixed(1)
                })

                return scoreSum
            }


            // 차트 데이터 요청 및 렌더링
            function chartDate(startDate, endDate, switchType) {
                $.ajax({
                    url: '/api/nps/chart',
                    type: 'post',
                    data: {startDate, endDate, switchType},
                    success: function (data) {
                        console.log("NPS Chart 데이터:", data)

                        // 날짜 조건에 맞게 데이터를 필터링
                        let startDateObj = new Date(startDate)
                        let endDateObj = new Date(endDate)

                        let filteredData = data.filter(date => {
                            let localDate = new Date(date.insertTime)
                            return localDate >= startDateObj && localDate <= endDateObj
                        })

                        let hotelData = filteredData.filter(hotel => hotel.hotelOrStore === 'hotel')
                        let storeData = filteredData.filter(store => store.hotelOrStore === 'store')

                        console.log("받아온 호텔 데이터 : ", hotelData)
                        console.log("받아온 스토어 데이터 : ", storeData)

                        let avgScores = {}

                        if (switchType === 'hotelChart'){
                            avgScores = questionScore(hotelData)
                            console.log("호텔 문항별 평균 점수 : ", avgScores)
                        }else if (switchType === 'storeChart'){
                            avgScores = questionScore(storeData)
                            console.log("스토어 문항별 평균 점수 : ", avgScores)
                        }else {
                            avgScores = questionScore(filteredData)
                            console.log("전체 문항별 평균 점수 : ", avgScores)
                        }

                        pieChart(avgScores)
                        barChart(avgScores)

                    },
                    error: function (xhr, status, error) {
                        console.log("NPS Chart 로딩 실패:", error)
                    }
                })
            }

            // 파이 차트 렌더링
            function pieChart(data) {
                if (pieChartInstance) pieChartInstance.destroy()

                const ctx = document.getElementById('pieChart').getContext('2d')
                pieChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(data),
                        datasets: [{
                            label: '문항별 평균 점수',
                            data: Object.values(data),
                            backgroundColor: ['#FF9999', '#66B2FF', '#99FF99', '#FFCC99', '#FF66FF'],
                        }]
                    }
                })
            }

            // 바 차트 렌더링
            function barChart(data) {
                if (barChartInstance) barChartInstance.destroy()

                const ctx = document.getElementById('barChart').getContext('2d')
                barChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data),
                        datasets: [{
                            label: '문항별 평균 점수',
                            data: Object.values(data),
                            backgroundColor: '#66B2FF',
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 5
                            }
                        }
                    }
                })
            }

        })
    </script>

</div>
</body>
</html>
