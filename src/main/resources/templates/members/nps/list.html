<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/desktop/layout}"> <!-- 공통 레이아웃 적용 -->

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <title>고객만족도 평가</title>
</head>

<body>

<div layout:fragment="adminContent" id="layoutSidenav_content">

    <main>
        <div class="container-fluid px-5">
            <h3 class="mt-5">고객만족도 평가</h3>
            <ol class="breadcrumb mb-4">
                <a href="/members/account/home" class="breadcrumb-item active">홈</a>
                <a href="/members/nps/list" class="breadcrumb-item active">통계</a>
                <a href="/members/nps/chart" class="breadcrumb-item active">데이터테이블</a>
            </ol>
        </div>

        <div class="card custom-shadow mb-4">
            <div class="card-body">

                <!-- 모든 필터를 하나의 부모 div에 넣어서 가로로 배치 -->
                <div class="filters" style="display: flex; align-items: center; gap: 20px;">
                    <!-- 날짜 필터링 -->
                    <div class="filter">
                        <label for="startDate">시작일:</label>
                        <input type="date" id="startDate" name="startDate">

                        <label for="endDate">종료일:</label>
                        <input type="date" id="endDate" name="endDate">

                        <button id="filterButton">조회</button>
                    </div>

                    <!-- 호텔 선택 필터 -->
                    <div class="filter">
                        <label for="hotelSelect">호텔</label>
                        <select id="hotelSelect">
                            <option value="">모든 호텔</option>
                        </select>
                    </div>

                    <!-- 스토어 선택 필터 -->
                    <div class="filter">
                        <label for="storeSelect">스토어</label>
                        <select id="storeSelect">
                            <option value="">모든 스토어</option>
                        </select>
                    </div>
                </div>


                <!-- 호텔 테이블 -->
                <h5 class="mt-4">호텔 고객만족도</h5>
                <table id="npsHotelTable" class="table table-bordered" style="display:none;">
                    <thead>
                    <tr>
                        <th>번호</th>
                        <th>매장</th>
                        <th>1문항</th>
                        <th>2문항</th>
                        <th>3문항</th>
                        <th>4문항</th>
                        <th>5문항</th>
                        <th>점수</th>
                        <th>기타문의</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <!-- 스토어 테이블 -->
                <h5 class="mt-4">스토어 고객만족도</h5>
                <table id="npsStoreTable" class="table table-bordered" style="display:none;">
                    <thead>
                    <tr>
                        <th>번호</th>
                        <th>매장</th>
                        <th>1문항</th>
                        <th>2문항</th>
                        <th>3문항</th>
                        <th>4문항</th>
                        <th>5문항</th>
                        <th>점수</th>
                        <th>기타문의</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>

            </div>
        </div>

    </main>

    <script>

        $(document).ready(function () {

            // 전역 변수 선언
            let npsList = []    // 전체 데이터 저장용
            let hotelData = []  // 호텔 데이터 분리
            let storeData = []  // 스토어 데이터 분리
            let stores = []     // 스토어 리스트 저장
            let hotels = []     // 호텔 리스트 저장
            let today = new Date()
            let startOfMonth = new Date(today.getFullYear(), today.getMonth(), 2)
            let endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1)

            // 날짜 필터 초기값 설정
            $('#startDate').val(formatDate(startOfMonth))  // 시작일
            $('#endDate').val(formatDate(endOfMonth))      // 종료일

            // 날짜 형식 변환 함수 (yyyy-mm-dd)
            function formatDate(date) {
                return date.toISOString().split('T')[0]
            }

            // 최초 페이지 진입 시 데이터를 불러오도록 처리
            loadNpsData($('#startDate').val(), $('#endDate').val());

            // 조회 버튼 클릭 시
            $('#filterButton').on('click', function () {
                let startDate = $('#startDate').val()
                let endDate = $('#endDate').val()

                // Ajax 요청을 통해 NPS 데이터 로딩
                loadNpsData(startDate, endDate)
            })

            // NPS 데이터 로드 함수
            function loadNpsData(startDate, endDate) {
                $.ajax({
                    url: '/api/nps/list',
                    method: 'GET',
                    data: {
                        startDate: startDate,
                        endDate: endDate
                    },
                    success: function (data) {
                        console.log("NPS 데이터 로딩 성공 : ", data)

                        // 받은 데이터를 npsList에 저장
                        npsList = data

                        // hotelOrStore 기준으로 데이터 필터링
                        hotelData = npsList.filter(item => item.hotelOrStore === 'hotel' && item.insertTime >= startDate && item.insertTime <= endDate)
                        storeData = npsList.filter(item => item.hotelOrStore === 'store' && item.insertTime >= startDate && item.insertTime <= endDate)

                        // 고유한 호텔 이름 추출하여 hotels 배열에 저장
                        hotels = [...new Set(hotelData.map(item => item.hotelName))]

                        // 셀렉트박스에 호텔 목록 추가
                        updateHotelSelectBox(hotels)

                        // 고유한 스토어 이름 추출하여 stores 배열에 저장
                        stores = [...new Set(storeData.map(item => item.storeName))]

                        // 셀렉트박스에 스토어 목록 추가
                        updateStoreSelectBox(stores)

                        // 테이블 렌더링 함수 호출
                        renderTables()
                    },
                    error: function (xhr, status, error) {
                        console.log("NPS 데이터 로딩 실패 : ", error)
                    }
                })
            }

            // 셀렉트박스에 호텔 목록 추가 함수
            function updateHotelSelectBox(hotels) {
                let hotelSelect = $('#hotelSelect')
                hotelSelect.empty()  // 기존 옵션 비우기

                // 기본 '모든 호텔' 옵션 추가
                hotelSelect.append('<option value="">모든 호텔</option>')

                // 호텔 이름을 셀렉트박스 옵션으로 추가
                hotels.forEach(hotel => {
                    hotelSelect.append(`<option value="${hotel}">${hotel}</option>`)
                })
            }

            // 셀렉트박스에 스토어 목록 추가 함수
            function updateStoreSelectBox(stores) {
                let storeSelect = $('#storeSelect')
                storeSelect.empty()  // 기존 옵션 비우기

                // 기본 '모든 스토어' 옵션 추가
                storeSelect.append('<option value="">모든 스토어</option>')

                // 스토어 이름을 셀렉트박스 옵션으로 추가
                stores.forEach(store => {
                    storeSelect.append(`<option value="${store}">${store}</option>`)
                })
            }

            // 셀렉트박스에서 호텔 선택 시 해당 호텔에 대한 설문만 필터링하여 렌더링
            $('#hotelSelect').on('change', function () {
                let selectedHotel = $(this).val()

                // 호텔별로 데이터를 필터링
                let filteredHotelData = selectedHotel ? hotelData.filter(nps => nps.hotelName === selectedHotel) : hotelData

                // 테이블 렌더링
                renderTable('#npsHotelTable', filteredHotelData)
            })

            // 셀렉트박스에서 스토어 선택 시 해당 스토어에 대한 설문만 필터링하여 렌더링
            $('#storeSelect').on('change', function () {
                let selectedStore = $(this).val()

                // 스토어별로 데이터를 필터링
                let filteredStoreData = selectedStore ? storeData.filter(nps => nps.storeName === selectedStore) : storeData

                // 테이블 렌더링
                renderTable('#npsStoreTable', filteredStoreData)
            })

            // 테이블 렌더링 함수
            function renderTables() {
                // 호텔 데이터 테이블
                if (hotelData.length > 0) {
                    $('#npsHotelTable').show()
                    renderTable('#npsHotelTable', hotelData)
                } else {
                    $('#npsHotelTable').hide()
                }

                // 스토어 데이터 테이블
                if (storeData.length > 0) {
                    $('#npsStoreTable').show()
                    renderTable('#npsStoreTable', storeData)
                } else {
                    $('#npsStoreTable').hide()
                }
            }

            // 개별 테이블 렌더링 함수
            function renderTable(tableId, data) {
                let tableBody = $(tableId).find('tbody')
                tableBody.empty()

                // 데이터를 테이블 형식으로 추가
                data.forEach(nps => {
                    let row = `
                    <tr>
                        <td>${nps.id}</td>
                        <td>${nps.hotelOrStore === 'hotel' ? nps.hotelName : nps.storeName}</td>
                        <td>${nps.questionOne}</td>
                        <td>${nps.questionTwo}</td>
                        <td>${nps.questionThree}</td>
                        <td>${nps.questionFour}</td>
                        <td>${nps.questionFive}</td>
                        <td>${nps.totalScore}</td>
                        <td>${nps.etcQuestion}</td>
                    </tr>
                `
                    tableBody.append(row)
                })
            }
        })

    </script>

</div>

</body>
</html>
