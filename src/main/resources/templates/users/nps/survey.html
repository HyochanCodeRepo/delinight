<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>고객 만족도 설문조사</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f7f7f7;
            margin: 0;
            padding: 0;
            color: #333;
        }

        h2 {
            text-align: center;
            margin-top: 40px;
            font-size: 32px;
            color: #4285F4;
        }

        .surveyWrap {
            width: 70%;
            margin: 30px auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .surveySection {
            margin-bottom: 30px;
        }

        .surveySection h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #5f6368;
            border-bottom: 2px solid #f1f1f1;
            padding-bottom: 10px;
        }

        .surveyQuestion {
            font-size: 18px;
            margin: 10px 0;
            color: #202124;
        }

        /* 라디오 버튼과 텍스트영역 스타일 수정 */
        .surveyRating {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 18px;
            color: #333;
            justify-content: flex-end;
        }

        .surveyRating input[type="radio"] {
            display: none;
        }

        .surveyRating label {
            cursor: pointer;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
            transition: background-color 0.3s, border-color 0.3s;
            text-align: center;
            width: 30px;
        }

        .surveyRating label:hover {
            background-color: #f0f0f0;
        }

        .surveyRating input:checked + label {
            background-color: #4285F4;
            border-color: #4285F4;
            color: white;
        }

        /* 텍스트영역 스타일 수정 */
        .surveyQuestion textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            min-height: 80px;
            resize: vertical;
            margin-top: 10px;
        }

        .submitBtn {
            width: 100%;
            padding: 15px;
            background-color: #4285F4;
            color: white;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .submitBtn:hover {
            background-color: #3367D6;
        }

        /* 버튼 중앙 정렬 */
        .buttonWrapper {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .submitBtn {
            width: auto;
            padding: 10px 25px;
        }

        /* 질문과 라디오 버튼 정렬 */
        .questionBlock {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .questionBlock label {
            width: 70%; /* 질문이 왼쪽에 위치하도록 */
            margin-right: 20px;
        }

        .questionBlock .surveyRating {
            width: 30%; /* 라디오 버튼이 오른쪽에 위치하도록 */
            display: flex;
            justify-content: flex-start;
            gap: 10px;
        }
    </style>
</head>
<body>
<h2>고객 만족도 평가</h2>

<!-- 호텔 설문 영역 -->
<div class="surveyWrap hotelNPSWrap"></div>

<!-- 스토어 설문 영역 -->
<div class="surveyWrap storeNPSWrap"></div>

<!-- 버튼을 감싸는 div -->
<div class="buttonWrapper">
    <button class="submitBtn saveSurveyBtn">설문 제출</button>
</div>

<script th:inline="javascript">

    $(document).ready(function () {
        console.log("로딩시작")

        let checkOutId = [[${checkOutId}]]
        let storeDTOList = [[${storeDTOList}]]
        let hotelId = [[${hotelId}]]
        let hotelName = [[${hotelName}]]

        console.log(checkOutId)
        console.log(storeDTOList)
        console.log(hotelId)
        console.log(hotelName)

        // 호텔 이름을 화면에 표시
        $(".hotelNPSWrap").prepend(`<h3>${hotelName} 설문</h3>`)

        // 호텔 설문 질문
        let hotelQuestions = [
            '객실의 청결 상태는 어떠했나요?',
            '직원의 친절도는 만족스러웠나요?',
            '숙박 가격에 대해 얼마나 만족하셨나요?',
            '시설(부대시설 포함)은 기대에 부응했나요?',
            '전반적인 만족도는 어느 정도였나요?'
        ]

        // 스토어 설문 질문
        let storeQuestions = [
            '상품의 품질은 어떠했나요?',
            '직원의 친절도는 만족스러웠나요?',
            '매장의 청결 상태는 어떠했나요?',
            '상품의 가격에 대해 만족하셨나요?',
            '전반적인 쇼핑 경험은 어떠셨나요?'
        ]

        // 설문 공통 HTML 생성 함수
        function generateQuestionBlock(prefix, id, labelPrefix, questionArray) {
            let html = `<div data-id="${id}"><h3>${labelPrefix} 설문</h3>`
            questionArray.forEach((question, i) => {
                html += `<label>${question}</label>`
                for (let j = 1; j <= 5; j++) {
                    html += `<input type="radio" name="${prefix}[${i}][${id}]" value="${j}"> ${j}`
                }
                html += "<br/>"
            })

            // 기타 문의사항 추가 부분
            html += `<label>기타 문의사항</label><br/>`
            html += `<textarea name="${prefix}_etc_${id}" rows="3" cols="50" placeholder="의견을 작성해주세요."></textarea><br/>`

            html += "</div>"
            return html
        }

        // 호텔 설문 생성
        let hotelHtml = generateQuestionBlock("hotel", hotelId, hotelName, hotelQuestions)
        $(".hotelNPSWrap").html(hotelHtml)

        // 스토어 설문 생성
        let storeHtml = ""
        storeDTOList.forEach(store => {
            storeHtml += generateQuestionBlock("store", store.id, store.name, storeQuestions)
        })
        $(".storeNPSWrap").html(storeHtml)

        // 응답 수집 함수
        function collectSurveyData(prefix, id, questionArray) {
            let dto = {
                checkOutId: checkOutId,
                hotelOrStore: prefix,
                id: id
            }

            if (prefix === 'hotel') {
                dto.hotelId = hotelId
            } else if (prefix === 'store') {
                dto.storeId = id
            }

            let score = 0
            let numQuestions = questionArray.length

            questionArray.forEach((label, idx) => {

                let rawVal = parseInt($(`input[name="${prefix}[${idx}][${id}]"]:checked`).val()) || 0
                let val = rawVal * 20

                switch (idx) {
                    case 0: dto.questionOne = val; break
                    case 1: dto.questionTwo = val; break
                    case 2: dto.questionThree = val; break
                    case 3: dto.questionFour = val; break
                    case 4: dto.questionFive = val; break
                }
                score += val
            })

            dto.totalScore = Math.round(score / numQuestions)

            // 수정된 부분: textarea 값 가져오기
            // name 속성으로 정확히 찾기
            let etcVal = $(`textarea[name="${prefix}_etc_${id}"]`).val() || ''
            dto.etcQuestion = etcVal

            return { dto }
        }

        // 제출 버튼 클릭 이벤트
        $(".saveSurveyBtn").click(function () {
            console.log("설문 제출 버튼 클릭")

            let npsList = []
            let hasEmptyAnswer = false

            // 호텔 응답 수집
            let hotelDTO = collectSurveyData("hotel", hotelId, hotelQuestions)
            npsList.push(hotelDTO.dto)

            // 스토어 응답 수집
            $('.storeNPSWrap > div').each(function () {
                let storeId = $(this).data('id')
                let storeDTO = collectSurveyData("store", storeId, storeQuestions)
                npsList.push(storeDTO.dto)
            })

            // 빈 응답 확인
            if (hasEmptyAnswer) {
                alert("모든 문항에 응답해주세요.")
                return
            }

            console.log("새롭게 만든 npsList: " + JSON.stringify(npsList))

            $.ajax({
                url: '/api/nps/saveSurvey',
                type: 'post',
                contentType: 'application/json',
                data: JSON.stringify(npsList),
                success: function (response) {
                    alert('설문 저장 성공 : ' + response)
                },
                error: function (xhr) {
                    alert('설문 저장 실패 : ' + xhr.responseText)
                }
            })
        })

    })

</script>

</body>
</html>
