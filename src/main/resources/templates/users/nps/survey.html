<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPS 설문</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        label {
            margin-top: 10px;
        }
        input[type="radio"] {
            margin-left: 5px;
        }
        button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
<h2>NPS 설문</h2>

<!-- 호텔 설문 영역 -->
<div class="hotelNPSWrap"></div>

<!-- 스토어 설문 영역 -->
<div class="storeNPSWrap"></div>

<!-- 제출 버튼 -->
<button class="saveSurveyBtn">제출</button>

<script th:inline="javascript">

    $(document).ready(function () {
        console.log("로딩시작")

        let checkOutId = [[${checkOutId}]]
        let storeDTOList = [[${storeDTOList}]]
        let hotelId = [[${hotelId}]]
        let hotelName = [[${hotelName}]]

        console.log(checkOutId)
        console.log(storeDTOList)
        console.log(hotelId)
        console.log(hotelName)

        // 호텔 이름을 화면에 표시
        $(".hotelNPSWrap").prepend(`<h3>${hotelName} 설문</h3>`)

        // 호텔 설문 질문
        let hotelQuestions = [
            '객실의 청결 상태는 어떠했나요?',
            '직원의 친절도는 만족스러웠나요?',
            '숙박 가격에 대해 얼마나 만족하셨나요?',
            '시설(부대시설 포함)은 기대에 부응했나요?',
            '전반적인 만족도는 어느 정도였나요?'
        ]

        // 스토어 설문 질문
        let storeQuestions = [
            '상품의 품질은 어떠했나요?',
            '직원의 친절도는 만족스러웠나요?',
            '매장의 청결 상태는 어떠했나요?',
            '상품의 가격에 대해 만족하셨나요?',
            '전반적인 쇼핑 경험은 어떠셨나요?'
        ]

        // 설문 공통 HTML 생성 함수
        function generateQuestionBlock(prefix, id, labelPrefix, questionArray) {
            let html = `<div data-id="${id}"><h3>${labelPrefix} 설문</h3>`
            questionArray.forEach((question, i) => {
                html += `<label>${question}</label>`
                for (let j = 1; j <= 5; j++) {
                    html += `<input type="radio" name="${prefix}[${i}][${id}]" value="${j}"> ${j}`
                }
                html += "<br/>"
            })

            // 기타 문의사항 추가 부분
            html += `<label>기타 문의사항</label><br/>`
            html += `<textarea name="${prefix}_etc_${id}" rows="3" cols="50" placeholder="의견을 작성해주세요."></textarea><br/>`

            html += "</div>"
            return html
        }

        // 호텔 설문 생성
        let hotelHtml = generateQuestionBlock("hotel", hotelId, hotelName, hotelQuestions)
        $(".hotelNPSWrap").html(hotelHtml)

        // 스토어 설문 생성
        let storeHtml = ""
        storeDTOList.forEach(store => {
            storeHtml += generateQuestionBlock("store", store.id, store.name, storeQuestions)
        })
        $(".storeNPSWrap").html(storeHtml)

        // 응답 수집 함수
        function collectSurveyData(prefix, id, questionArray) {
            let dto = {
                checkOutId: checkOutId,
                hotelOrStore: prefix,
                id: id
            }

            if (prefix === 'hotel') {
                dto.hotelId = hotelId
            } else if (prefix === 'store') {
                dto.storeId = id
            }

            let score = 0
            let numQuestions = questionArray.length

            questionArray.forEach((label, idx) => {

                let rawVal = parseInt($(`input[name="${prefix}[${idx}][${id}]"]:checked`).val()) || 0
                let val = rawVal * 20

                switch (idx) {
                    case 0: dto.questionOne = val; break
                    case 1: dto.questionTwo = val; break
                    case 2: dto.questionThree = val; break
                    case 3: dto.questionFour = val; break
                    case 4: dto.questionFive = val; break
                }
                score += val
            })

            dto.totalScore = Math.round(score / numQuestions)

            // 수정된 부분: textarea 값 가져오기
            let etcVal = $(`textarea[name="${prefix}_etc_${id}"]`).val() || ''  // name 속성으로 정확히 찾기
            dto.etcQuestion = etcVal

            return { dto }
        }

        // 제출 버튼 클릭 이벤트
        $(".saveSurveyBtn").click(function () {
            console.log("설문 제출 버튼 클릭")

            let npsList = []
            let hasEmptyAnswer = false

            // 호텔 응답 수집
            let hotelDTO = collectSurveyData("hotel", hotelId, hotelQuestions)
            npsList.push(hotelDTO.dto)

            // 스토어 응답 수집
            $('.storeNPSWrap > div').each(function () {
                let storeId = $(this).data('id')
                let storeDTO = collectSurveyData("store", storeId, storeQuestions)
                npsList.push(storeDTO.dto)
            })

            // 빈 응답 확인
            if (hasEmptyAnswer) {
                alert("모든 문항에 응답해주세요.")
                return
            }

            console.log("새롭게 만든 npsList: " + JSON.stringify(npsList))

            $.ajax({
                url: '/api/nps/saveSurvey',
                type: 'post',
                contentType: 'application/json',
                data: JSON.stringify(npsList),
                success: function (response) {
                    alert('설문 저장 성공 : ' + response)
                },
                error: function (xhr) {
                    alert('설문 저장 실패 : ' + xhr.responseText)
                }
            })
        })

    })

</script>

</body>
</html>
