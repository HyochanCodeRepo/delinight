<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mobile/layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"
            integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>

    <title>1:1 문의하기</title>
    <link rel="stylesheet" href="/css/mobile.css">
</head>

<body>
<div class="container-fluid px-3" layout:fragment="content">

    <h2>문의 상세보기</h2>

    <div class="card p-3 mt-3">
        <div class="card-body">

            <!-- 글 정보 -->
            <div class="row mb-3">
                <div class="col-4 fw-bold">글번호</div>
                <div class="col" th:text="${inquireDTO.id}"></div>
            </div>

            <div class="row mb-3">
                <div class="col-4 fw-bold">제목</div>
                <div class="col" th:text="${inquireDTO.title}"></div>
            </div>

            <div class="row mb-3">
                <div class="col-4 fw-bold">내용</div>
                <div class="col" th:text="${inquireDTO.content}"></div>
            </div>

            <!-- 수정/이전 버튼 -->
            <div class="row mt-4">
                <div class="col-6 pe-1">
                    <a th:href="@{|/users/inquire/update/${inquireDTO.id}|}" class="btn btn-primary w-100" style="height: 50px;">수정</a>
                </div>
                <div class="col-6 ps-1">
                    <a href="/users/inquire/list" class="btn btn-secondary w-100" style="height: 50px;">이전</a>
                </div>
            </div>

            <!-- 답변 등록 -->
            <div class="mt-4">
                <label class="fw-bold">답변 내용</label>
                <textarea name="replyText" class="form-control replyText mt-2" rows="1" oninput="autoResize(this)"
                          style="overflow:hidden; resize: none; min-height: 3rem;"></textarea>
                <button type="button" class="btn btn-success w-100 mt-2 insertBtn" style="height: 45px;">답변 저장</button>
            </div>

            <!-- 댓글 목록 -->
            <div class="mt-4">
                <label class="fw-bold">댓글 내용</label>
                <div class="p-3" style="border:1px solid #ddd; border-radius:8px; min-height: 80px;" id="replyWrap"></div>
            </div>

        </div>
    </div>

    <!-- 스크립트 영역 -->
    <script th:inline="javascript">
        $(function () {
            select();

            $(".insertBtn").on("click", function () {
                const replyTextVal = $(".replyText").val().trim();
                const inquireId = [[${inquireDTO.id}]];

                if (!replyTextVal) {
                    alert("댓글 내용을 입력해주세요.");
                    return;
                }

                const insertD = {
                    replyText: replyTextVal,
                    inquireId: inquireId
                };

                $.ajax({
                    url: "/reply/register",
                    type: "post",
                    data: $.param(insertD),
                    success: function (response) {
                        alert(response);
                        $(".replyText").val("");
                        select();
                    },
                    error: function (xhr) {
                        if (xhr.status === 400) {
                            let errors;
                            try {
                                errors = JSON.parse(xhr.responseText);
                            } catch (e) {
                                alert("유효성 오류 응답을 파싱할 수 없습니다.");
                                return;
                            }
                            let msg = "입력 오류:\n";
                            errors.forEach(e => {
                                msg += "- " + e.defaultMessage + "\n";
                            });
                            alert(msg);
                        } else {
                            alert("서버 오류가 발생했습니다.");
                        }
                    }
                });
            });

            function select() {
                var inquireId = [[${inquireDTO.id}]];

                $.ajax({
                    url: "/reply/list/" + inquireId,
                    type: "get",
                    success: function (data) {
                        let str = "";
                        for (let i = 0; i < data.length; i++) {
                            str += `<div class="mb-2">${data[i].replyText}</div>`;
                        }
                        $("#replyWrap").html(str);
                    }
                });
            }
        });
    </script>

    <script>
        function autoResize(a) {
            a.style.height = 'auto';
            a.style.height = a.scrollHeight + 'px';
        }
    </script>

</div>
</body>
</html>
