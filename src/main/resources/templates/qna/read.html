<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}"
>
<head>
    <title>델리나잇</title>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <!-- 부트스트랩 JS 추가 (필수!) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>




    <!--별도 css 필요할 시 아래로 추가-->
    <!--어디서 그대로 가져오는거 아니면 클래스 이름 잘 붙여주고
    styles.css에 작성할것-->
</head>

<body>
<div layout:fragment="adminContent" id="layoutSidenav_content">
    <main>
        <!--내용 넣는 곳-->
        <div class="container-fluid px-4">
            <!--페이지 이름-->
            <h1 class="mt-4">상세보기</h1>
            <!--텍스트 박스-->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="container">
                        <div class="row mt-5">
                            <div class="col-2"></div>
                            <div class="col-6">
                                <div class="card">

                                    <div class="card-header">
                                        <h2>문의사항</h2>
                                    </div>

                                    <div class="card-body">

                                        <div>
                                            <a th:href="@{|/qna/update/${qnaDTO.id}|}" class="btn btn-success">수정</a>
                                            <button type="submit" class="btn btn-danger">삭제</button>

                                        </div>


                                        <div class="row md-3">
                                            <div class="col-4">글번호</div>
                                            <div class="col" th:text="${qnaDTO.id}"></div>
                                        </div>

                                        <div class="row md-3">
                                            <div class="col-4">제목</div>
                                            <div class="col" th:text="${qnaDTO.title}"></div>
                                        </div>

                                        <div class="row md-3">
                                            <div class="col-4">내용</div>
                                            <div class="col" th:text="${qnaDTO.content}"></div>
                                        </div>

                                        <div>

                                            <div class="col mt-3">
                                                <label>답변내용</label><br>
                                                <textarea class="replyText" name="replyText"></textarea><br>
                                                <label>작성자</label><br>
                                                <input class="replyer" name="reply"><br>
                                            </div>
                                            <div class="col mt-3">
                                                <button class="insertBtn">저장</button>
                                            </div>
                                        </div>

                                        <div class="replyWrap"></div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script th:inline="javascript">

            $(".insertBtn").on("click", function (){
                const replyTextVal = $(".replyText").val().trim(); //클래스가 붙은 입력창에서 값을 가져옴
                //trim()은 공백을 제거 (양쪽 끝에있는 스페이스, 탭같은거)
                const replyer = $(".replyer").val().trim();
                const qnaId = [[${qnaDTO.id}]]; //서버에 넘겨주는 QnaId

                if (!replyTextVal){
                    alert("댓글 내용을 입력해주세요.")
                    return;
                }

                const insertD = {
                    replyText: replyTextVal,
                    replyer : replyer,
                    qnaId: qnaId
                };//서버로 보낼 데이터 묶음 내용 + 글번호

                $.ajax({
                    url: "/reply/register",
                    type: "post",
                    data: $.param(insertD),//객체를 replyText=내용&qnaId=숫자 이런 식의 문자열로 바꿈
                    success: function (response) {
                        alert(response); //예) "3번글이 저장되었습니다.
                        $(".replyText").val(""); //입력창 초기화
                        $(".replyer").val("");
                        select();//댓글 목록 다시 불러오기

                    },
                    error: function (xhr) {
                        if (xhr.status === 400){//실패 이유가 400이면 유효성 검사 실패로 판단
                            let errors;
                            try {//서버에서 에러 정보를 문자열(JSON)로 보내줬을때
                                //그걸 자바스크립트 객체로 변환하려고 함
                                errors = JSON.parse(xhr.responseText);
                            }catch (e){
                                alert("유효성 오류 응답을 파싱할 수 없습니다.")
                                return;
                            }//실패하면 "응답을 파싱할 수 없다"는 메세지
                            let msg = "입력 오류:\n";
                            errors.forEach(e => {
                                msg += "_ " + e.defaultMessage + "\n";
                            });//여러 개의 유효성 오류가 있을 수 있으니
                            //하나씩 돌면서 메세지를 쌓아서 보여줌
                            alert(msg);
                        }else {
                            alert("서버 오류가 발생했습니다.");
                        }

                    }
                });
            });

            $(function select(){
                var qnaId = [[${qnaDTO.id}]]


                $.ajax({

                    url: "/reply/list/" + qnaId,
                    type: "get",
                    success: function (data) {
                        console.log(data)
                        let str = "";
                        for (let i = 0; i < data.length; i++) {
                            str += `<span>${data[i].id}</span><br>
                                    <span>${data[i].replyText}</span>
                                    <span>${data[i].replyer}</span>`
                        }
                        $(".replyWrap").html(str)
                    }

                })
            })



        </script>
    </main>
</div>


<!--푸터 절대 수정 금지!!!!-->
<!--푸터-->
<div th:replace="~{fragments/adminfooter::adminFooter}"></div>
</div>
<div class="result" style="margin-top: 30px">

</div>




</body>
</html>
